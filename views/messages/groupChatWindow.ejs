<% layout("/layouts/boilerplate") %>
<body>
  <style>
    .head {
      width: 90%;
      border-radius: 1.5rem !important;
      border: 1px solid black;
      background-color: rgb(199, 244, 244) !important;
      font-weight: bolder;
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: auto;
      margin-top: 1rem;
    }
    .outerContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 90%;
      height: 65vh;
      margin: auto;
      margin-top: 1rem;
    }
    .onlineUsers {
      width: 30% !important;
      height: 100%;
      border: 1px solid black;
      border-radius: 1.5rem !important;
      background-color: rgb(255, 255, 255) !important;
      margin-right: 1.5rem;
    }
    .ChatSpace {
      width: 70%;
      height: 100%;
      border: 1px solid black;
      border-radius: 1.5rem !important;
      background-color: rgb(255, 255, 255) !important;

      /* display: flex;
      justify-content: center;
      align-items: center; */
    }
    .chattingHead,
    .UserHead {
      width: 100%;
      height: 3.5rem;
      background-color: rgb(189, 249, 249);
      border-top-left-radius: inherit;
      border-top-right-radius: inherit;
      display: flex;
      align-items: center;
      padding-left: 1rem;
      position: sticky;
    }
    .innerChatSpace,
    .innerUsers {
      width: 100%;
      height: calc(100% - 6.3rem);
      border-bottom-left-radius: inherit;
      border-bottom-right-radius: inherit;
      overflow-y: auto;
      padding-bottom: 0.5rem;
    }
    .profile-container {
      position: relative;
      display: inline-block;
    }
    .profile-image {
      width: 65px; /* Adjust the size as needed */
      height: 65px; /* Adjust the size as needed */
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffffff; /* Border color for the image */
      margin-right: 0.6rem;
    }

    .user-profile-image {
      width: 50px; /* Adjust the size as needed */
      height: 50px; /* Adjust the size as needed */
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffffff; /* Border color for the image */
      margin-right: 0.6rem;
    }

    .online-indicator {
      position: absolute;
      top: 0;
      left: 0;
      width: 15px;
      height: 15px;
      background-color: #2ecc71; /* Green color for online indicator */
      border-radius: 50%;
      border: 2px solid #fff; /* Border color for the indicator */
    }
    .info h6 {
      margin-bottom: 1px;
    }

    .info p {
      opacity: 0.7;
      margin-bottom: 0;
    }
    .userInfo {
      align-items: center;
    }

    .userInfo {
      width: 100%;
      height: 4rem;
      display: flex;
      font-size: small;
      padding: 0.4rem 0.7rem;
      background-color: white;
      border-top: 1px solid black;
    }

    .userInfo:hover {
      background-color: rgb(205, 255, 255);
      cursor: pointer;
    }

    .userInfo i {
      position: relative;
      left: 25rem;
      align-self: center;
      font-size: medium;
    }

    @media only screen and (max-width: 412px) {
      .head {
        display: none;
      }
      .outerContainer {
        display: block;
        width: 100%;
        height: 80%;
        margin-top: 5px;
      }
      .onlineUsers {
        width: 98% !important;
        margin: auto;
        height: 40%;
        margin-bottom: 5px;
      }
      .ChatSpace {
        width: 98% !important;
        margin: auto;
        height: 85%;
      }
    }
    .form-control {
      width: calc(100% - 24px) !important;
    }
    .outerTypeMsg {
      background-color: aqua;
      border-radius: inherit;
      border: 1px solid black;
      padding: 0.2rem;
      padding-right: 0.7rem;
    }
    .typeMsg {
      display: flex;
    }
    .sentMsg,
    .recMsg {
      min-height: 10%;
      border: 1px solid black;
      border-radius: 2rem;
      padding: 0.8rem;
      min-width: 20%;
      max-width: 80%;
      margin-top: 0.5rem;
      padding-bottom: 0.1rem;

      padding-left: 0.3rem;
      padding-top: 0.1rem;
      width: fit-content;
      display: flex;
      align-items: center;
    }
    .sendUserImage {
      margin-right: 0.5rem;
    }
    .sendUserImage img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }
    .time {
      display: flex;
      justify-content: flex-end;
      font-size: small;
    }
    .time p {
      margin-bottom: 0;
      margin-top: 0.5rem;
    }
    .sentMsg {
      margin-left: auto;
      background-color: antiquewhite;
    }
    .recMsg {
      margin-right: auto;
      background-color: #fff;
    }
    .newUserJoined {
      width: 100%;
      background-color: #83f1b1;
      border-radius: 1rem;
      margin-top: 0.5rem;
      text-align: center;
    }
    .newUserJoined p {
      margin-bottom: 0;
    }
    .userLeft {
      width: 100%;
      background-color: rgb(255, 180, 195);
      border-radius: 1rem;
      margin-top: 0.5rem;
      text-align: center;
    }

    .userLeft p {
      margin-bottom: 0;
    }
  </style>
  <div class="head shadow p-3 bg-body-tertiary rounded">
    <h1 style="margin-bottom: 0">
      Welcome <%= currUser.username %> to Group Chat
    </h1>
  </div>

  <div class="outerContainer">
    <div class="onlineUsers shadow bg-body-tertiary rounded">
      <div class="UserHead">
        <h3 style="margin-bottom: 0">All Online Users</h3>
      </div>
      <div class="innerUsers" id="innerUsers">
        <% for (user of allUsers) { %> <% if(user.is_online_in_group === true){
        %>
        <div class="userInfo" id="<%= user._id %>-LiveUser">
          <div class="profile-container">
            <img
              class="user-profile-image"
              src="<%= user.image.url %>"
              alt="User Profile"
            />
            <div class="online-indicator" id="<%= user._id %>-usersArray"></div>
          </div>
          <div class="info">
            <h6>
              <%= user.username %><%= currUser && user._id.toString() ===
              currUser._id.toString() ? " (You)" : "" %>
            </h6>
            <!-- time -->
          </div>
        </div>
        <% }%> <% } %>
      </div>
    </div>
    <div class="ChatSpace shadow bg-body-tertiary rounded">
      <div class="chattingHead">
        <h3 style="margin-bottom: 0">Chats</h3>
      </div>
      <div class="innerChatSpace" id="innerChatSpace">
        <div class="sentMsg">
          <div class="sendUserImage">
            <img
              src="https://res.cloudinary.com/dqusuosoq/image/upload/v1707375884/SocialBook/s0jsaaoe0jp3jewr9pti.jpg"
              alt="image"
            />
          </div>
          <div>
            <div><p style="margin-bottom: 0">Hellow</p></div>
            <div class="time"><p>10:45 pm</p></div>
          </div>
        </div>
        <div class="recMsg">
          <div class="sendUserImage">
            <img
              src="https://res.cloudinary.com/dqusuosoq/image/upload/v1707375884/SocialBook/s0jsaaoe0jp3jewr9pti.jpg"
              alt="image"
            />
          </div>
          <div>
            <div>
              <p style="margin-bottom: 0">
                iam Fine , What about U Lorem ipsum dolor sit amet consectetur
                adipisicing elit. Perferendis at modi eum dolorem optio nulla,
                voluptate, officiis impedit, inventore unde ipsum tenetur minus
                vitae molestias asperiores tempora voluptatum. Dolor, cumque.
                Enim, obcaecati accusantium aut assumenda, ipsam tempore nemo a
                deserunt voluptate ea provident quo quae culpa repellendus
                delectus alias amet quis ducimus sequi. Autem neque nostrum
                dolores inventore tenetur fugiat?
              </p>
            </div>
            <div class="time"><p>10:45 pm</p></div>
          </div>
        </div>
      </div>
      <div class="outerTypeMsg">
        <form style="width: 100%; height: 100%" id="sentForm">
          <div class="typeMsg">
            <input
              style="margin-right: 0.5rem; border-radius: 1rem"
              type="text"
              placeholder="Enter Message"
              class="form-control"
              id="msgInp"
            /><button class="btn btn-success">Send</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>

<script>
  const socket = io("/groupChatNameSpace", {
    auth: {
      token: "<%= currUser._id %>",
    },
  });

  socket.on("GroupUserOnline", (data) => {
    let time = luxon.DateTime.fromJSDate(new Date(data.cntTime), {
      zone: "Asia/Kolkata",
    }).toLocaleString({
      hour: "numeric",
      minute: "numeric",
      hour12: true,
    });
    let LiveUser = data.currUser;
    let curr_id = "<%= currUser._id %>";
    let innerUsers = document.getElementById("innerUsers");
    let html = `<div class="userInfo" id="${LiveUser._id}-LiveUser">
          <div class="profile-container">
            <img
              class="user-profile-image"
              src="${LiveUser.image.url}"
              alt="User Profile"
            />
            <div class="online-indicator" id="${LiveUser._id}-usersArray"></div>
          </div>
          <div class="info">
            <h6>
              ${LiveUser.username} ${
      curr_id && LiveUser._id.toString() === curr_id.toString() ? " (You)" : ""
    }
            </h6>
            <!-- time -->
          </div>
        </div>`;
    $("#innerUsers").append(html);
    let html1 = `<div class="newUserJoined"><p>${
      curr_id && LiveUser._id.toString() === curr_id.toString()
        ? "(You) "
        : `${LiveUser.username}`
    }Joined the Chat! @ ${time}</p></div>
`;

    $(".innerChatSpace").append(html1);

    scrollUp("innerChatSpace");
  });

  socket.on("GroupUserOffline", (data) => {
    console.log("user log");
    let time = luxon.DateTime.fromJSDate(new Date(data.disCntTime), {
      zone: "Asia/Kolkata",
    }).toLocaleString({
      hour: "numeric",
      minute: "numeric",
      hour12: true,
    });
    let LiveUser = data.currUser;
    $(`#${LiveUser._id}-LiveUser`).remove();
    let html1 = `<div class="userLeft"><p>${LiveUser.username} Left the Chat! @ ${time}</p></div>
`;

    $(".innerChatSpace").append(html1);

    scrollUp("innerChatSpace");
  });

  document.getElementById("sentForm").addEventListener("submit", (e) => {
    e.preventDefault();
    let msg = document.getElementById("msgInp").value;
    console.log(msg);

    $.ajax({
      url: "/saveGrpMsg/<%=currUser._id %>",
      type: "post",
      data: { msg: msg },
      success: (data) => {
        let time = luxon.DateTime.fromJSDate(new Date(data.obj.createdAt), {
          zone: "Asia/Kolkata",
        }).toLocaleString({
          hour: "numeric",
          minute: "numeric",
          hour12: true,
        });
        let html = `<div class="sentMsg">
          <div class="sendUserImage">
            <img
              src="${data.obj.sendUserImg}"
              alt="image"
            />
          </div>
          <div>
            <div><p style="margin-bottom: 0">${data.obj.msg}</p></div>
            <div class="time"><p>${time}</p></div>
          </div>
        </div>`;
        $(".innerChatSpace").append(html);
        document.getElementById("msgInp").value = "";
        scrollUp("innerChatSpace");
        socket.emit("grpMsgSent", data);
      },
    });
  });

  socket.on("recGrpMsg", (data) => {
    let time = luxon.DateTime.fromJSDate(new Date(data.obj.createdAt), {
      zone: "Asia/Kolkata",
    }).toLocaleString({
      hour: "numeric",
      minute: "numeric",
      hour12: true,
    });
    let html = `<div class="recMsg">
          <div class="sendUserImage">
            <img
              src="${data.obj.sendUserImg}"
              alt="image"
            />
          </div>
          <div>
            <div><p style="margin-bottom: 0">${data.obj.msg}</p></div>
            <div class="time"><p>${time}</p></div>
          </div>
        </div>`;
    $(".innerChatSpace").append(html);
    scrollUp("innerChatSpace");
  });

  function scrollUp(id) {
    $(`#${id}`).animate(
      {
        scrollTop: $(`#${id}`).offset().top + $(`#${id}`)[0].scrollHeight,
      },
      0
    );
  }
</script>
